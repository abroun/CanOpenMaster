//------------------------------------------------------------------------------
// File: CanOpenTest.cpp
// Desc: Example program that lets you interact with a CANBUS network
//------------------------------------------------------------------------------

//------------------------------------------------------------------------------
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include "CanOpenMaster/CanOpenMaster.h"

//------------------------------------------------------------------------------
// CanOpen event callbacks
//------------------------------------------------------------------------------
void HeartbeatErrorCallback( COM_CanChannelHandle handle, uint8_t error )
{
    printf( "Got heartbeat error callback\n" );
}

//------------------------------------------------------------------------------
void PostSyncCallback( COM_CanChannelHandle handle )
{
    printf( "Got post sync callback\n" );
}

//------------------------------------------------------------------------------
void PostTpdoCallback( COM_CanChannelHandle handle )
{
    printf( "Got post TPDO callback\n" );
}

//------------------------------------------------------------------------------
void PostEmergencyCallback( COM_CanChannelHandle handle, 
                            uint8_t nodeId, uint16_t errCode, uint8_t errReg )
{
    printf( "PostEmergency called for node %i - ErrorCode: 0x%X, ErrorReg: 0x%X\n", 
            nodeId, errCode, errReg );
}

//------------------------------------------------------------------------------
void PostSlaveBootupCallback( COM_CanChannelHandle handle, uint8_t nodeId )
{
    printf( "Got slave bootup callback for node %i\n", nodeId );
}

//------------------------------------------------------------------------------
void onExit( void )
{
    printf( "Exit handler called\n" );
    
    COM_Deinit();
}

//------------------------------------------------------------------------------
int main( int argc, char** argv )
{
    // Initialise the CanOpenMaster library
    if ( !COM_Init() )
    {
        fprintf( stderr, "Error: Unable to initialise the CanOpenMaster library\n" );
        return -1;
    }
    
    atexit( onExit );
    
    // Open a CAN channel
    COM_CanChannelCallbacks callbacks;
    memset( &callbacks, 0, sizeof( callbacks ) );
    
    callbacks.mHeartbeatErrorCB = HeartbeatErrorCallback;
    callbacks.mPostSyncCB = PostSyncCallback;
    callbacks.mPostTpdoCB = PostTpdoCallback;
    callbacks.mPostEmergencyCB = PostEmergencyCallback;
    callbacks.mPostSlaveBootupCB = PostSlaveBootupCallback;
    
    COM_CanChannelHandle channelHandle = COM_OpenChannel( "", "1M", callbacks );
    if ( NULL == channelHandle )
    {
        fprintf( stderr, "Error: Unable to open CAN channel\n" );
        exit( -1 );
    }
    
    printf( "Opened channel...\n" );
    
    // Reset all nodes and wait
    if ( !COM_QueueNmtResetNode( channelHandle, 0 ) )
    {
        fprintf( stderr, "Error: Unable to send NMT reset node message\n" );
        exit( -1 );
    }
    printf( "Resetting nodes...\n" );
    
    getchar();
    
    COM_CloseChannel( &channelHandle );
    
    return 0;
}

